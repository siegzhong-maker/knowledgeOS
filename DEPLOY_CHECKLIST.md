# 部署前检查清单

## ✅ 代码检查

- [x] 修复了 API 重复声明错误（`api.js`）
- [x] 修复了 COUNT 查询问题（`knowledge.js`）
- [x] 所有性能优化已完成
- [x] 代码已通过 lint 检查

## 📦 部署准备

### 1. Git 提交
```bash
# 检查当前状态
git status

# 添加所有更改
git add .

# 提交更改
git commit -m "性能优化：修复 N+1 查询、优化资源加载、添加缓存等"

# 推送到远程仓库
git push origin main
```

### 2. Railway 部署检查

#### 环境变量确认
- [ ] `DATABASE_URL` - Railway 会自动注入（PostgreSQL）
- [ ] `NODE_ENV` = `production`（可选，Railway 会自动设置）
- [ ] `PORT` - Railway 会自动设置

#### 服务配置确认
- [ ] Web 服务已连接 GitHub 仓库
- [ ] PostgreSQL 数据库服务已创建
- [ ] 数据库服务已连接到 Web 服务

### 3. 部署后验证步骤

#### 步骤 1：检查部署日志
1. 在 Railway 项目页面，查看最新部署
2. 确认：
   - ✅ 构建成功
   - ✅ 数据库连接成功
   - ✅ 应用启动成功
   - ✅ 数据库表初始化成功

#### 步骤 2：健康检查
访问：`https://your-app.up.railway.app/api/health`

应该返回：
```json
{"success":true,"message":"服务运行正常"}
```

#### 步骤 3：前端功能测试
1. **页面加载速度**
   - 打开应用首页
   - 使用 Chrome DevTools Performance 面板
   - 检查 LCP 应该 < 2.5 秒

2. **数据加载测试**
   - 打开"文档库"页面
   - 确认文档列表正常加载
   - 打开"知识库"页面
   - 确认知识列表正常加载（应该比之前快很多）

3. **资源加载检查**
   - 打开 Network 面板
   - 刷新页面
   - 确认：
     - ✅ PDF.js 和 D3.js 不在初始加载中
     - ✅ 有多个 preconnect 和 dns-prefetch 链接
     - ✅ 非关键资源异步加载

4. **API 性能测试**
   - 打开控制台
   - 运行性能测试（如果可用）：
   ```javascript
   // 测试知识列表 API
   const start = performance.now();
   await fetch('/api/knowledge/items?limit=50');
   console.log('响应时间:', performance.now() - start, 'ms');
   ```

#### 步骤 4：功能完整性测试
- [ ] 文档上传功能正常
- [ ] 知识提取功能正常
- [ ] 知识列表显示正常
- [ ] 搜索和筛选功能正常
- [ ] PDF 查看器正常（按需加载）
- [ ] 知识图谱正常（按需加载）

## 🐛 常见问题排查

### 问题 1：部署失败
**检查：**
- 查看 Railway 部署日志
- 确认 Node.js 版本 >= 20
- 确认所有依赖已安装

### 问题 2：数据库连接失败
**检查：**
- 确认 PostgreSQL 服务状态为 "Online"
- 确认 `DATABASE_URL` 环境变量已自动注入
- 查看应用日志中的数据库连接信息

### 问题 3：数据加载失败
**检查：**
- 打开浏览器控制台，查看错误信息
- 检查 Network 面板，查看 API 请求状态
- 确认数据库表已正确初始化

### 问题 4：性能没有改善
**检查：**
- 清除浏览器缓存
- 使用无痕模式测试
- 检查 Network 面板，确认资源按需加载
- 检查 API 响应时间

## 📊 性能对比

部署后，记录以下指标并与优化前对比：

| 指标 | 优化前 | 优化后 | 改善 |
|------|--------|--------|------|
| LCP | 5.99 秒 | ? | ? |
| 知识列表 API | 慢 | ? | ? |
| 页面加载时间 | 慢 | ? | ? |
| Performance Score | < 50 | ? | ? |

## 🚀 快速部署命令

如果使用 Railway CLI：

```bash
# 安装 Railway CLI（如果还没有）
npm i -g @railway/cli

# 登录
railway login

# 链接项目
railway link

# 部署
railway up
```

## 📝 部署后任务

1. **监控性能**
   - 使用 Railway 的 Metrics 面板监控应用性能
   - 查看错误日志

2. **用户反馈**
   - 收集用户对性能改善的反馈
   - 监控实际使用中的性能指标

3. **持续优化**
   - 根据实际使用情况进一步优化
   - 考虑添加更多缓存策略
   - 监控数据库查询性能

## ✅ 部署完成确认

- [ ] 应用可以正常访问
- [ ] 所有功能正常工作
- [ ] 性能指标符合预期
- [ ] 没有控制台错误
- [ ] 数据库操作正常

---

**部署成功后，记得测试所有功能，确保性能优化没有破坏任何功能！**
